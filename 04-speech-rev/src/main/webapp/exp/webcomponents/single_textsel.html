<link rel="import" href="../framework/polymer/polymer.html">
<link rel="import" href="../webcomponents/single_radio.html">

<!--
cybelia.kao 2017.07: Single text multiple choice box
main feature: Multiple choices
usage:
<single-textsel>
  <option value="value">text</option>
  ....
</single-textsel>
-->

<dom-module id="single-textsel">

    <template>
        <style>
        p {
            padding: 0px;
            margin: 0px;
            border: none;
            line-height: 60%;
        }
        </style>
    </template>

    <script>
    Polymer({
        is: 'single-textsel',
        properties: {
            name: {
                type: String,
                value: ""
            },
            value: {
                type: String,
                notify: true,
                value: ""
            }
        },
        ready: function() {
            // In case we are inside other Polymer element, the first element may be a slot linking to outside shadow DOM
            // In this case, we need to traverse out to get the actual option content
            var listNode = this.children;
            while (true) {
                var haveSlot = false;
                for (var i=0; i<listNode.length; i++) {
                    if (listNode[i].tagName === 'SLOT') {
                        listNode = listNode[i].assignedNodes();
                        haveSlot = true;
                        break; // break out for loop
                    }
                } // end for each node
                if (haveSlot === false) break;
            }
            
            // In case no name given, construct a super-brute-force hash for innerHTML
            if (this.name.length <= 0) {
                var hash = 0;
                for (var i=0; i<this.innerHTML.length; i++) {
                    var chr = this.innerHTML.charCodeAt(i);
                    hash = chr + (hash << 6) + (hash << 16) - hash;
                }
                this.name = (this.id ? this.id : "") + hash.toString();
            }
            
            // Typesetting the select menu
            this.listOptions = [];
            for (var i=0; i<listNode.length; i++) {
                var tag = listNode[i];
                if (tag.tagName !== "OPTION") continue;
                
                var boxOption = document.createElement('single-radio');
                boxOption.text = tag.innerHTML;
                boxOption.value = tag.value;
                if (this.name.length > 0) {
                    boxOption.name = this.name;
                }
                this.shadowRoot.appendChild(boxOption);
                this.listOptions.push(boxOption);
                
                boxOption.addEventListener("change", function(event) {
                    if (event.target.checked === true) {
                        this.value = event.target.value;
                        this.dispatchEvent(new Event('change', {target: this, bubbles: true}));
                    };
                }.bind(this));
            } // end for each options
            
            // When the component property changed, also reflect that change to underlying radioboxes
            this.addEventListener('value-changed', function(event) {
                if (!this.listOptions) return;
                for (var i=0; i<this.listOptions.length; i++) {
                    var objOption = this.listOptions[i];
                    objOption.checked = this.value === objOption.value;
                }
            }.bind(this));
        }, // end ready hook
    });
    </script>

</dom-module>
