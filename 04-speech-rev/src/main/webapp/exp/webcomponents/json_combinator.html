<link rel="import" href="../framework/polymer/polymer.html">
<link rel="import" href="../webcomponents/single_textsel.html">

<dom-module id="json-combinator">

    <template>
        <div id="all-combinators" style="width:80%; margin-top: 15px; margin-bottom: 15px">
            <table cellpadding="8">
                <tr id="real-combinators" style="vertical-align: top">
                </tr>
            </table>
        </div>
        JSON Residual: <input id="residual" type="text" value="{{residual::change}}" style="width: 60%" />
    </template>

    <script>
    Polymer({
        is: 'json-combinator',
        properties: {
            residual: {
                type: String,
                value: "{}"
            },
            name: {
                type: String,
                value: ""
            },
            value: {
                type: String,
                notify: true
            }
        },
        
        ready: function() {
            // In case we are inside other Polymer element, the first element may be a slot linking to outside shadow DOM
            // In this case, we need to traverse out to get the actual option content
            var listNode = this.children;
            while (true) {
                var haveSlot = false;
                for (var i=0; i<listNode.length; i++) {
                    if (listNode[i].tagName === 'SLOT') {
                        listNode = listNode[i].assignedNodes();
                        haveSlot = true;
                        break; // break out for loop
                    }
                } // end for each node
                if (haveSlot === false) break;
            }
            
            var objContain = this.$['real-combinators'];
            this.listKeys = [];
            this.mapTypes = {};
            this.mapKeys = {};
            for (var i=0; i<listNode.length; i++) {
                var tag = listNode[i];
                if (tag.tagName !== "OPTGROUP") continue;
                
                var objTableBox = document.createElement('td');
                var objSelector = document.createElement('single-textsel');
                var key = tag.attributes.getNamedItem("name").nodeValue;
                objSelector.name = ((this.name.length>0) ? this.name+"-" : "") + key;
                objSelector.value = tag.value;
                
                var k=0; // index to get
                for (var j=tag.children.length; j>0; j--) {
                    var subtag = tag.children[k];
                    if (subtag.tagName !== "OPTION") {
                        k++;
                        continue;
                    }
                    objSelector.appendChild(subtag);
                }

                // Event listener: on clicking radio buttons, change json value
                objSelector.addEventListener("change", function(event) {
                    this.doSyncUp();
                    this.dispatchEvent(new Event('change', {target: this, bubbles: true}));
                }.bind(this));
                
                objTableBox.innerHTML = "<center><b>" + (tag.label ? tag.label : key) + "</b></center>";
                objTableBox.appendChild(objSelector);
                objContain.appendChild(objTableBox);
                
                this.listKeys.push(key);
                this.mapKeys[key] = objSelector;
                // Do some type checking: if float, don't quote
                if (tag.classList.contains("float")) {
                    this.mapTypes[key] = "float";
                } else if (tag.classList.contains("int")) {
                    this.mapTypes[key] = "int";
                }
            }
            
            //// Propagate select event up to host element
            //this.$['selector'].addEventListener('change', function(event) {
            //    this.dispatchEvent(new Event('change', {target: this, bubbles: true}));
            //}.bind(this));
            // Propagate text change event up to host element
            this.$['residual'].addEventListener("change", function(event) {
                this.doSyncUp();
                this.dispatchEvent(new Event('change', {target: this, bubbles: true}));
            }.bind(this));
            
            // On value change, try to update radio selection
            this.addEventListener('value-changed', function(event) {
                this.doSyncDown();
            }.bind(this));
            
        }, // end ready hook
        
        // Function to sync contents of this component into its value
        doSyncUp: function() {
            var rslt;
            try {
                rslt = JSON.parse(this.$['residual'].value);
            } catch(err) {
                console.error("JSON Residual content seem to have syntax error.");
                console.error(err);
                rslt = {};
            }
            
            for (var i=0; i<this.listKeys.length; i++) {
                var key = this.listKeys[i];
                var objSelector = this.mapKeys[key];
                if (objSelector.value !== void 0 && objSelector.value !== "") {
                    if (this.mapTypes[key] === 'float') {
                        rslt[key] = parseFloat(objSelector.value);
                    } else if (this.mapTypes[key] === 'int') {
                        rslt[key] = parseInt(objSelector.value);
                    } else {
                        rslt[key] = objSelector.value;
                    }
                }
            }
            
            this.value = JSON.stringify(rslt);
        },
        
        // Function to sync value into its components
        doSyncDown: function() {
            var rslt;
            try {
                rslt = JSON.parse(this.value);
            } catch(err) {
                console.error("JSON value seem to have syntax error.");
                console.error(err);
                rslt = "{}";
            }
            
            for (var i=0; i<this.listKeys.length; i++) {
                var key = this.listKeys[i];
                var objSelector = this.mapKeys[key];
                if (rslt[key] !== void 0 && typeof rslt[key].toString === 'function') {
                    objSelector.value = rslt[key].toString();
                } else {
                    objSelector.value = rslt[key];
                }
                delete rslt[key];
            }
            this.$['residual'].value = JSON.stringify(rslt);
        }
    });
    </script>

</dom-module>
